<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="pin.png">
    <title>PUYA MCU Pin Configurator</title>
    <meta name="description"
        content="PUYA MCU Pin Configurator - Configure GPIO, UART, TIM, and ADC pins for PUYA microcontrollers easily online.">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .mcu-body {
            background: #333;
            border-radius: 4px;
            position: relative;
        }

        .pin {
            cursor: pointer;
            transition: all 0.2s;
        }

        .pin:hover {
            fill: #4ade80 !important;
        }

        .pin-selected {
            fill: #22c55e !important;
            stroke: white;
            stroke-width: 1px;
        }

        .pin-label {
            font-size: 10px;
            fill: white;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-gray-900 text-gray-100 p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 border-b border-gray-700 pb-4 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-green-500">PUYA MCU Pin Configurator</h1>
                <div class="mt-2">
                    <label for="mcu-select" class="block mb-1 text-sm font-medium text-gray-400">Select MCU:</label>
                    <select id="mcu-select"
                        class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block w-full p-2.5">
                        <option value="PY32F002BF15P6">PY32F002BF15P6 - TSSOP20</option>
                        <option value="PY32F030K28T6">PY32F030K28T6 - LQFP32</option>
                        <option value="PY32F030L14D6">PY32F030L14D6 - DFN8</option>
                        <option value="PY32F030F26P6">PY32F030F26P6 - TSSOP20</option>
                        <option value="PY32F040R1BT6">PY32F040R1BT6 - LQFP64</option>
                        <option value="PY32F040C1BT6">PY32F040C1BT6 - LQFP48</option>
                        <option value="PY32F040K1BU6">PY32F040K1BU6 - QFN32</option>
                        <option value="PY32F040C1BT7">PY32F040C1BT7 - LQFP48</option>
                        <option value="PY32F071R1BT6">PY32F071R1BT6 - LQFP64</option>
                        <option value="PY32F071R1BU6">PY32F071R1BU6 - QFN64</option>
                        <option value="PY32F071C1BT6">PY32F071C1BT6 - LQFP48</option>
                        <option value="PY32F071C1BU6">PY32F071C1BU6 - QFN48</option>
                        <option value="PY32F071K18U6">PY32F071K18U6 - QFN32</option>
                        <option value="PY32F071C1BT7">PY32F071C1BT7 - LQFP48</option>
                        <option value="PY32F072R1BT6">PY32F072R1BT6 - LQFP64</option>
                        <option value="PY32F072C1BT6">PY32F072C1BT6 - LQFP48</option>
                        <option value="PY32F072C1BU6">PY32F072C1BU6 - QFN48</option>
                        <option value="PY32F072K1BU6">PY32F072K1BU6 - QFN32</option>
                        <option value="PY32F403V1DT6">PY32F403V1DT6 - LQFP100</option>
                        <option value="PY32F403R2DT6">PY32F403R2DT6 - LQFP64</option>
                        <option value="PY32F403C1BT6">PY32F403C1BT6 - LQFP48</option>
                        <option value="PY32F403C1CU6">PY32F403C1CU6 - QFN48</option>
                        <option value="PY32F403K1BU6">PY32F403K1BU6 - QFN32</option>
                        <option value="PY32L020F15U6">PY32L020F15U6 - QFN20</option>
                        <option value="PY32L020L15D6">PY32L020L15D6 - DFN8</option>
                        <option value="PY32L020F15P7">PY32L020F15P7 - TSSOP20</option>
                        <option value="PY32T020G15P7">PY32T020G15P7 - TSSOP28</option>
                    </select>
                </div>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-gray-500 text-xs font-mono mb-1">v1.0.2</span>
                <div class="flex gap-4 items-center">
                    <a href="https://www.assemcorp.com/en" target="_blank" class="hover:opacity-80 transition-opacity">
                        <img src="assemcorp.png" alt="Assemcorp" class="h-12 bg-white rounded p-1">
                    </a>
                    <a href="https://www.puyasemi.com/en/" target="_blank" class="hover:opacity-80 transition-opacity">
                        <img src="puya.png" alt="Puya" class="h-12 bg-white rounded p-1">
                    </a>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <div class="flex flex-col items-center bg-gray-800 p-10 rounded-xl shadow-2xl">
                <h2 class="mb-6 text-xl font-semibold">Chip View</h2>
                <svg width="400" height="500" viewBox="0 0 300 400">
                    <rect x="75" y="50" width="150" height="300" class="mcu-body" />
                    <circle cx="90" cy="65" r="5" fill="#555" /> <text x="150" y="200" text-anchor="middle" fill="#666"
                        font-size="14" font-weight="bold">PY32F002B</text>

                    <g id="pins-left"></g>
                    <g id="pins-right"></g>
                </svg>
            </div>

            <div class="space-y-6">
                <div id="config-panel" class="bg-gray-800 p-6 rounded-xl border border-gray-700 hidden">
                    <h2 id="selected-pin-name" class="text-2xl font-bold text-green-400 mb-4 font-mono">Select Pin</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-400">Function</label>
                            <select id="func-select"
                                class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2 focus:ring-green-500">
                            </select>
                        </div>

                        <div id="dynamic-params" class="space-y-4">
                            <!-- Dynamic Content Here -->
                        </div>

                        <div class="mt-4">
                            <button id="create-btn"
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition-colors duration-200">
                                Create Code
                            </button>
                        </div>

                        <div class="p-4 bg-gray-900 rounded-lg mt-6">
                            <h3 class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-widest">Generated Code
                                (CMSIS)</h3>
                            <pre id="code-output" class="text-green-300 font-mono text-sm leading-relaxed"></pre>
                        </div>
                    </div>
                </div>

                <div id="welcome-msg" class="text-center p-12 border-2 border-dashed border-gray-700 rounded-xl">
                    <p class="text-gray-500 text-lg">Click a pin to configure.</p>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center text-gray-500 text-sm pb-8">
            For more examples and applications: <a href="https://github.com/Assemcorp" target="_blank"
                class="text-green-500 hover:text-green-400">https://github.com/Assemcorp</a>
        </footer>
    </div>

    <script>
        // Dokümandan alınan pin verileri (PY32F002B) [cite: 682, 727, 731]
        const py32f002b_data = {
            1: { name: "PA5", functions: ["GPIO", "TIM1_CH1", "TIM14_CH1", "USART_CK", "ADC_IN3"] },
            2: { name: "PA6", functions: ["GPIO", "SPI_NSS", "USART_TX", "EVENTOUT", "ADC_IN3"] },
            3: { name: "PA7", functions: ["GPIO", "SPI_MOSI", "USART_RX", "TIM1_CH4", "ADC_IN4"] },
            4: { name: "PC0-NRST", functions: ["NRST", "GPIO", "SWDIO", "TIM1_CH1N", "ADC_IN5"] },
            5: { name: "PC1-OSCIN", functions: ["GPIO", "SPI_MISO", "OSCIN"] },
            6: { name: "PB7", functions: ["GPIO", "SPI_MOSI", "TIM14_CH1", "OSCOUT"] },
            7: { name: "VSS", functions: ["Ground"], type: "power" },
            8: { name: "PB6-SWDIO", functions: ["SWDIO", "GPIO", "USART_TX", "I2C_SDA", "ADC_IN6"] },
            9: { name: "VCC", functions: ["Power Supply"], type: "power" },
            10: { name: "PB5", functions: ["GPIO", "SPI_NSS", "TIM1_CH3", "TIM14_CH1"] },
            11: { name: "PB4", functions: ["GPIO", "USART_TX", "I2C_SDA"] },
            12: { name: "PB3", functions: ["GPIO", "USART_CK", "TIM1_BKIN", "I2C_SCL"] },
            13: { name: "PB2", functions: ["GPIO", "SPI_SCK", "USART_CTS", "TIM1_CH1N"] },
            14: { name: "PB1", functions: ["GPIO", "USART_RTS", "TIM1_CH2N", "ADC_IN0"] },
            15: { name: "PB0", functions: ["GPIO", "SPI_SCK", "TIM1_CH2", "ADC_IN7"] },
            16: { name: "PA0", functions: ["GPIO", "SPI_MOSI", "TIM1_CH3N"] },
            17: { name: "PA1", functions: ["GPIO", "SPI_MISO", "TIM1_CH1"] },
            18: { name: "PA2-SWCLK", functions: ["SWCLK", "GPIO", "USART_RX", "TIM1_CH4"] },
            19: { name: "PA3", functions: ["GPIO", "USART_TX", "TIM1_CH2", "ADC_IN1"] },
            20: { name: "PA4", functions: ["GPIO", "USART_RX", "TIM1_CH3", "ADC_IN2"] }
        };

        // Current active pin data
        let currentPinData = {};

        // MCU Package Definitions
        const mcuDefinitions = {
            "PY32F002BF15P6": { package: "TSSOP20", pins: 20, data: py32f002b_data },
            "PY32F030K28T6": { package: "LQFP32", pins: 32 },
            "PY32F030L14D6": { package: "DFN8", pins: 8 },
            "PY32F030F26P6": { package: "TSSOP20", pins: 20 },
            "PY32F040R1BT6": { package: "LQFP64", pins: 64 },
            "PY32F040C1BT6": { package: "LQFP48", pins: 48 },
            "PY32F040K1BU6": { package: "QFN32", pins: 32 },
            "PY32F040C1BT7": { package: "LQFP48", pins: 48 },
            "PY32F071R1BT6": { package: "LQFP64", pins: 64 },
            "PY32F071R1BU6": { package: "QFN64", pins: 64 },
            "PY32F071C1BT6": { package: "LQFP48", pins: 48 },
            "PY32F071C1BU6": { package: "QFN48", pins: 48 },
            "PY32F071K18U6": { package: "QFN32", pins: 32 },
            "PY32F071C1BT7": { package: "LQFP48", pins: 48 },
            "PY32F072R1BT6": { package: "LQFP64", pins: 64 },
            "PY32F072C1BT6": { package: "LQFP48", pins: 48 },
            "PY32F072C1BU6": { package: "QFN48", pins: 48 },
            "PY32F072K1BU6": { package: "QFN32", pins: 32 },
            "PY32F403V1DT6": { package: "LQFP100", pins: 100 },
            "PY32F403R2DT6": { package: "LQFP64", pins: 64 },
            "PY32F403C1BT6": { package: "LQFP48", pins: 48 },
            "PY32F403C1CU6": { package: "QFN48", pins: 48 },
            "PY32F403K1BU6": { package: "QFN32", pins: 32 },
            "PY32L020F15U6": { package: "QFN20", pins: 20 },
            "PY32L020L15D6": { package: "DFN8", pins: 8 },
            "PY32L020F15P7": { package: "TSSOP20", pins: 20 },
            "PY32T020G15P7": { package: "TSSOP28", pins: 28 }
        };

        const svgContainer = document.querySelector('svg');
        const mcuSelect = document.getElementById('mcu-select');

        mcuSelect.addEventListener('change', (e) => {
            const mcuCode = e.target.value;
            loadMCU(mcuCode);
        });

        function loadMCU(mcuCode) {
            const def = mcuDefinitions[mcuCode] || { package: "Unknown", pins: 0 };

            // Generate generic data if not available
            if (def.data) {
                currentPinData = def.data;
            } else {
                currentPinData = {};
                for (let i = 1; i <= def.pins; i++) {
                    currentPinData[i] = { name: `Pin ${i}`, functions: ["GPIO", "Unknown"], type: "signal" };
                }
            }

            // Update Labels
            document.querySelector('#welcome-msg p').textContent = `${mcuCode} (${def.package}) Selected. Click a pin to configure.`;
            document.querySelector('text[font-weight="bold"]').textContent = mcuCode;

            // Clear SVG
            svgContainer.innerHTML = ''; // Clear all

            // Draw Package
            if (def.package.startsWith("TSSOP") || def.package.startsWith("DFN")) {
                drawDualInlinePackage(def.pins, def.package);
            } else if (def.package.startsWith("LQFP") || def.package.startsWith("QFN")) {
                drawQuadPackage(def.pins, def.package);
            } else {
                drawGenericPackage(def.package);
            }
        }

        function createSvgElement(tag, attrs) {
            const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
            for (let k in attrs) el.setAttribute(k, attrs[k]);
            return el;
        }

        function drawDualInlinePackage(pinCount, pkgName) {
            const pinsPerSide = pinCount / 2;
            const pinPitch = 25;
            const bodyWidth = 120;
            const bodyHeight = (pinsPerSide * pinPitch) + 40;
            const startY = 50;
            const centerX = 150; // SVG viewBox 300 width

            // Body
            svgContainer.appendChild(createSvgElement("rect", {
                x: centerX - (bodyWidth / 2), y: startY, width: bodyWidth, height: bodyHeight, class: "mcu-body"
            }));

            // Pin 1 Indicator
            svgContainer.appendChild(createSvgElement("circle", {
                cx: centerX - (bodyWidth / 2) + 15, cy: startY + 15, r: 5, fill: "#555"
            }));

            // Label
            svgContainer.appendChild(createSvgElement("text", {
                x: centerX, y: startY + (bodyHeight / 2), "text-anchor": "middle", fill: "#666", "font-size": "14", "font-weight": "bold"
            })).textContent = pkgName;

            const group = createSvgElement("g", {});
            svgContainer.appendChild(group);

            for (let i = 1; i <= pinsPerSide; i++) {
                // Left side
                createPin(i, centerX - (bodyWidth / 2) - 30, startY + 20 + (i - 1) * pinPitch, 30, 15, group, "left");
                // Right side (counting down)
                const rightPinId = pinCount - i + 1;
                createPin(rightPinId, centerX + (bodyWidth / 2), startY + 20 + (i - 1) * pinPitch, 30, 15, group, "right");
            }
        }

        function drawQuadPackage(pinCount, pkgName) {
            const pinsPerSide = pinCount / 4;
            const pinPitch = 20; // Tighter pitch for quad
            const bodySize = (pinsPerSide * pinPitch) + 60;
            const startX = (300 - bodySize) / 2;
            const startY = 50;
            const centerX = 150;
            const centerY = startY + (bodySize / 2);

            // Body
            svgContainer.appendChild(createSvgElement("rect", {
                x: startX, y: startY, width: bodySize, height: bodySize, class: "mcu-body", rx: 10
            }));

            // Pin 1 Indicator (Top-Left corner usually)
            svgContainer.appendChild(createSvgElement("circle", {
                cx: startX + 15, cy: startY + 15, r: 5, fill: "#555"
            }));

            // Label
            svgContainer.appendChild(createSvgElement("text", {
                x: centerX, y: centerY, "text-anchor": "middle", fill: "#666", "font-size": "14", "font-weight": "bold"
            })).textContent = pkgName;

            const group = createSvgElement("g", {});
            svgContainer.appendChild(group);

            // Pins mapping logic for Quad Flat Package (counter-clockwise starting from top-left logic usually, but standard is 1 at Top-Left or Left-Top)
            // Standard QFP pinout: Pin 1 at top-left corner, going CCW? Or Pin 1 at left-top?
            // Usually Pin 1 is at the top-left corner of the package, or left side top.
            // Let's assume standard Counter-Clockwise numbering starting from Left Side -> Bottom -> Right -> Top (or similar)
            // BUT for simplicity in visualization:
            // Side 1 (Left): 1 to N
            // Side 2 (Bottom): N+1 to 2N
            // Side 3 (Right): 2N+1 to 3N
            // Side 4 (Top): 3N+1 to 4N

            // Adjusting to standard visual representation:
            // Pins 1..N on Left (Top to Bottom)
            // Pins N+1..2N on Bottom (Left to Right)
            // Pins 2N+1..3N on Right (Bottom to Top)
            // Pins 3N+1..4N on Top (Right to Left)

            let pinId = 1;

            // Left Side
            for (let i = 0; i < pinsPerSide; i++) {
                createPin(pinId++, startX - 30, startY + 30 + i * pinPitch, 30, 10, group, "left");
            }
            // Bottom Side
            for (let i = 0; i < pinsPerSide; i++) {
                createPin(pinId++, startX + 30 + i * pinPitch, startY + bodySize, 10, 30, group, "bottom");
            }
            // Right Side
            for (let i = 0; i < pinsPerSide; i++) {
                createPin(pinId++, startX + bodySize, startY + bodySize - 30 - i * pinPitch, 30, 10, group, "right"); // Bottom to Top
            }
            // Top Side
            for (let i = 0; i < pinsPerSide; i++) {
                createPin(pinId++, startX + bodySize - 30 - i * pinPitch, startY - 30, 10, 30, group, "top"); // Right to Left
            }
        }

        function createPin(id, x, y, w, h, parent, side) {
            const pData = currentPinData[id] || { type: "signal", name: `P${id}` };

            const rect = createSvgElement("rect", {
                x: x, y: y, width: w, height: h,
                class: "pin " + (pData.type === 'power' ? 'fill-red-900' : 'fill-gray-600'),
                id: "pin-rect-" + id
            });
            rect.onclick = () => selectPin(id);

            // Text Label
            let tx = x, ty = y;
            let anchor = "start";

            if (side === "left") { tx = x - 5; ty = y + h / 1.5; anchor = "end"; }
            if (side === "right") { tx = x + w + 5; ty = y + h / 1.5; anchor = "start"; }
            if (side === "bottom") { tx = x + w / 2; ty = y + h + 12; anchor = "middle"; }
            if (side === "top") { tx = x + w / 2; ty = y - 5; anchor = "middle"; }

            const text = createSvgElement("text", {
                x: tx, y: ty, "text-anchor": anchor, class: "pin-label"
            });
            text.textContent = id; // Show Pin Number only to save space

            parent.appendChild(rect);
            parent.appendChild(text);
        }

        // Variable to store current selection
        let selectedPinId = null;

        function selectPin(id) {
            document.querySelectorAll('.pin').forEach(p => p.classList.remove('pin-selected'));
            const pRect = document.getElementById('pin-rect-' + id);
            if (pRect) pRect.classList.add('pin-selected');

            document.getElementById('welcome-msg').classList.add('hidden');
            const panel = document.getElementById('config-panel');
            panel.classList.remove('hidden');

            const pin = currentPinData[id];
            // Safe check if pin exists
            if (!pin) return;

            selectedPinId = id; // Store selected pin ID
            document.getElementById('selected-pin-name').textContent = `Pin ${id} - ${pin.name}`;

            const funcSelect = document.getElementById('func-select');

            // Clear previous code output
            document.getElementById('code-output').textContent = "// Click 'Create Code' to generate";

            if (pin.functions && pin.functions.length > 0) {
                funcSelect.innerHTML = pin.functions.map(f => `<option value="${f}">${f}</option>`).join('');
                // Trigger change to render params
                renderConfigParams(pin.functions[0]);
                funcSelect.onchange = (e) => renderConfigParams(e.target.value);
            } else {
                funcSelect.innerHTML = '<option value="Unknown">No Data</option>';
                renderConfigParams("Unknown");
            }
        }

        const paramSchemas = {
            GPIO: [
                { id: 'mode', label: 'Mode', type: 'select', options: ['GPIO_MODE_INPUT', 'GPIO_MODE_OUTPUT_PP', 'GPIO_MODE_OUTPUT_OD', 'GPIO_MODE_AF_PP', 'GPIO_MODE_AF_OD', 'GPIO_MODE_ANALOG'] },
                { id: 'pull', label: 'Pull', type: 'select', options: ['GPIO_NOPULL', 'GPIO_PULLUP', 'GPIO_PULLDOWN'] },
                { id: 'speed', label: 'Speed', type: 'select', options: ['GPIO_SPEED_FREQ_LOW', 'GPIO_SPEED_FREQ_MEDIUM', 'GPIO_SPEED_FREQ_HIGH', 'GPIO_SPEED_FREQ_VERY_HIGH'] }
            ],
            UART: [
                { id: 'baud', label: 'Baud Rate', type: 'select', options: ['9600', '19200', '38400', '57600', '115200'] },
                { id: 'wordlen', label: 'Word Length', type: 'select', options: ['UART_WORDLENGTH_8B', 'UART_WORDLENGTH_9B'] },
                { id: 'stopbits', label: 'Stop Bits', type: 'select', options: ['UART_STOPBITS_1', 'UART_STOPBITS_2'] },
                { id: 'parity', label: 'Parity', type: 'select', options: ['UART_PARITY_NONE', 'UART_PARITY_EVEN', 'UART_PARITY_ODD'] },
                { id: 'hwflow', label: 'Hw Flow Ctl', type: 'select', options: ['UART_HWCONTROL_NONE', 'UART_HWCONTROL_RTS', 'UART_HWCONTROL_CTS', 'UART_HWCONTROL_RTS_CTS'] },
                { id: 'mode', label: 'Mode', type: 'select', options: ['UART_MODE_TX_RX', 'UART_MODE_TX', 'UART_MODE_RX'] }
            ],
            TIM: [
                { id: 'prescaler', label: 'Prescaler', type: 'number', options: ['0'] },
                { id: 'period', label: 'Period', type: 'number', options: ['999'] },
                { id: 'clockdivision', label: 'Clock Division', type: 'select', options: ['TIM_CLOCKDIVISION_DIV1', 'TIM_CLOCKDIVISION_DIV2', 'TIM_CLOCKDIVISION_DIV4'] },
                { id: 'countermode', label: 'Counter Mode', type: 'select', options: ['TIM_COUNTERMODE_UP', 'TIM_COUNTERMODE_DOWN'] }
            ],
            ADC: [
                { id: 'resolution', label: 'Resolution', type: 'select', options: ['ADC_RESOLUTION_12B', 'ADC_RESOLUTION_10B', 'ADC_RESOLUTION_8B'] },
                { id: 'align', label: 'Data Align', type: 'select', options: ['ADC_DATAALIGN_RIGHT', 'ADC_DATAALIGN_LEFT'] },
                { id: 'scan', label: 'Scan Conv Mode', type: 'select', options: ['ADC_SCAN_DIRECTION_FORWARD', 'ADC_SCAN_DIRECTION_BACKWARD'] }
            ]
        };

        function renderConfigParams(funcName) {
            const container = document.getElementById('dynamic-params');
            container.innerHTML = '';

            let type = 'GPIO';
            if (funcName.includes('USART') || funcName.includes('UART')) {
                type = 'UART';
            } else if (funcName.includes('TIM')) {
                type = 'TIM';
            } else if (funcName.includes('ADC')) {
                type = 'ADC';
            }

            const params = paramSchemas[type] || paramSchemas.GPIO;

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 gap-4';

            params.forEach(p => {
                const div = document.createElement('div');
                const label = document.createElement('label');
                label.className = 'block text-sm font-medium text-gray-400';
                label.textContent = p.label;

                const select = document.createElement('select');
                select.id = `param-${p.id}`;
                select.className = 'mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2 focus:ring-green-500 text-white';

                p.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    select.appendChild(option);
                });

                // Allow editable input if type is number (simulated with select for now, or change to input)
                if (p.type === 'number') {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `param-${p.id}`;
                    input.value = p.options[0];
                    input.className = 'mt-1 block w-full bg-gray-700 border-gray-600 rounded-md p-2 focus:ring-green-500 text-white';
                    div.appendChild(label);
                    div.appendChild(input);
                } else {
                    div.appendChild(label);
                    div.appendChild(select);
                }
                grid.appendChild(div);
            });

            container.appendChild(grid);
        }

        // Add event listener for Create button
        document.getElementById('create-btn').addEventListener('click', () => {
            if (selectedPinId && currentPinData[selectedPinId]) {
                updateCode(currentPinData[selectedPinId]);
            }
        });

        function updateCode(pin) {
            const funcSelect = document.getElementById('func-select');
            const funcName = funcSelect ? funcSelect.value : "GPIO";

            // Extract Port/Pin
            let portName = "GPIOA";
            let pinName = "GPIO_PIN_0";
            const match = pin.name.match(/P([A-F])(\d+)/);
            if (match) {
                portName = `GPIO${match[1]}`;
                pinName = `GPIO_PIN_${match[2]}`;
            }

            let code = ``;

            if (funcName.includes('USART') || funcName.includes('UART')) {
                // UART Logic
                const baud = document.getElementById('param-baud').value;
                const wordlen = document.getElementById('param-wordlen').value;
                const stopbits = document.getElementById('param-stopbits').value;
                const parity = document.getElementById('param-parity').value;
                const hwflow = document.getElementById('param-hwflow').value;
                const mode = document.getElementById('param-mode').value;

                // Infer Instance
                let instance = "USART1"; // Default
                if (funcName.includes("USART2")) instance = "USART2";

                code += `void APP_UartConfig(void)
{
  // UART Configuration for ${pin.name} (${funcName})
  // GPIO Configuration for UART Alternate Function
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  __HAL_RCC_${portName}_CLK_ENABLE();
  
  GPIO_InitStruct.Pin = ${pinName};
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_PULLUP;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
  GPIO_InitStruct.Alternate = GPIO_AF1_USART1; // TODO: Lookup correct AF
  HAL_GPIO_Init(${portName}, &GPIO_InitStruct);

  // UART Peripheral Init
  huart1.Instance = ${instance};
  huart1.Init.BaudRate = ${baud};
  huart1.Init.WordLength = ${wordlen};
  huart1.Init.StopBits = ${stopbits};
  huart1.Init.Parity = ${parity};
  huart1.Init.Mode = ${mode};
  huart1.Init.HwFlowCtl = ${hwflow};
    HAL_UART_Init(&huart1);
}
`;
            } else if (funcName.includes('TIM')) {
                const prescaler = document.getElementById('param-prescaler').value;
                const period = document.getElementById('param-period').value;
                const clockdiv = document.getElementById('param-clockdivision').value;
                const countermode = document.getElementById('param-countermode').value;

                let instance = "TIM1";
                if (funcName.includes("TIM14")) instance = "TIM14";

                code += `void APP_TimConfig(void)
{
  // Timer Configuration for ${pin.name} (${funcName})
  TIM_HandleTypeDef htim;
  
  /* TIM Peripheral Clock Enable */
  __HAL_RCC_${instance}_CLK_ENABLE();
  
  // GPIO Configuration (AF)
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  __HAL_RCC_${portName}_CLK_ENABLE();
  GPIO_InitStruct.Pin = ${pinName};
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_HIGH;
  GPIO_InitStruct.Alternate = GPIO_AF_TIM; // TODO: Adjust AF
  HAL_GPIO_Init(${portName}, &GPIO_InitStruct);

  htim.Instance = ${instance};
  htim.Init.Prescaler = ${prescaler};
  htim.Init.CounterMode = ${countermode};
  htim.Init.Period = ${period};
  htim.Init.ClockDivision = ${clockdiv};
  htim.Init.RepetitionCounter = 0;
  htim.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  HAL_TIM_Base_Init(&htim);
}`;

            } else if (funcName.includes('ADC')) {
                const res = document.getElementById('param-resolution').value;
                const align = document.getElementById('param-align').value;
                const scan = document.getElementById('param-scan').value;

                code += `void APP_AdcConfig(void)
{
  // ADC Configuration for ${pin.name} (${funcName})
  ADC_HandleTypeDef hadc;
  
  /* ADC Peripheral Clock Enable */
  __HAL_RCC_ADC_CLK_ENABLE();
  
  // GPIO Configuration (Analog)
  GPIO_InitTypeDef GPIO_InitStruct = {0};
  __HAL_RCC_${portName}_CLK_ENABLE();
  GPIO_InitStruct.Pin = ${pinName};
  GPIO_InitStruct.Mode = GPIO_MODE_ANALOG;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  HAL_GPIO_Init(${portName}, &GPIO_InitStruct);

  hadc.Instance = ADC1;
  hadc.Init.ClockPrescaler = ADC_CLOCK_SYNC_PCLK_DIV1;
  hadc.Init.Resolution = ${res};
  hadc.Init.DataAlign = ${align};
  hadc.Init.ScanConvMode = ${scan};
  hadc.Init.EOCSelection = ADC_EOC_SINGLE_CONV;
  hadc.Init.LowPowerAutoWait = ENABLE;
  HAL_ADC_Init(&hadc);
}`;
            } else {
                // Default GPIO Logic
                const mode = document.getElementById('param-mode') ? document.getElementById('param-mode').value : 'GPIO_MODE_INPUT';
                const pull = document.getElementById('param-pull') ? document.getElementById('param-pull').value : 'GPIO_NOPULL';
                const speed = document.getElementById('param-speed') ? document.getElementById('param-speed').value : 'GPIO_SPEED_FREQ_LOW';

                code += `void APP_GpioConfig(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};

  /* GPIO Ports Clock Enable */
  __HAL_RCC_${portName}_CLK_ENABLE();

  /* Configure GPIO pin : ${pinName} */
  GPIO_InitStruct.Pin = ${pinName};
  GPIO_InitStruct.Mode = ${mode};
  GPIO_InitStruct.Pull = ${pull};
  GPIO_InitStruct.Speed = ${speed};
  HAL_GPIO_Init(${portName}, &GPIO_InitStruct);
}`;
            }

            document.getElementById('code-output').textContent = code;
        }

        // Initialize with default
        loadMCU(mcuSelect.value);
    </script>
</body>

</html>